<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regional Conflicts by Decade - EsfViz Project</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="regional-conflicts-styles.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="visualization-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-back">‚Üê Back to Home</a>
            <h1 class="nav-title">Regional Conflicts Analysis</h1>
            <img src="nav-icon.png" alt="Regional Conflicts logo" class="nav-logo" width="20px" height="20px">
        </div>
    </nav>

    <!-- Main Content -->
    <div class="visualization-page">
        <div class="container">
            
            <!-- New Inter vs Intra-political Conflicts Analysis -->
            <section class="viz-description">
                <h2>Inter-political vs. Intra-political Conflicts by Region</h2>
                <p>
                    This visualization analyzes the percentage distribution of inter-political and intra-political conflicts 
                    across different regions throughout modern history. Using comprehensive historical war data, we examine 
                    how different conflict types have been distributed geographically across the entire timeframe.
                </p>
                <p>
                    The grouped stacked bar chart shows, for each region, two bars representing the percentage distribution 
                    of inter-political (Type 1-2) vs. intra-political (Type 3-6) conflicts. Each bar is further subdivided 
                    by conflict subtype, providing insights into the nature of conflicts within each broad category.
                </p>
                
                <div class="chart-info">
                    <p><strong>Inter-political Conflicts:</strong> Wars between different political entities (conquest, balance of power)</p>
                    <p><strong>Intra-political Conflicts:</strong> Internal wars within political entities (civil wars, secessions)</p>
                    <p><strong>Multi-region wars:</strong> Count toward all regions involved</p>
                    <p><strong>Visualization:</strong> Grouped stacked bars with interactive tooltips and embedded legend</p>
                </div>
            </section>

            <!-- Inter vs Intra-political Chart Container -->
            <section class="visualization-container">
                <div id="inter-intra-loading" class="loading-message">
                    Loading inter-political vs. intra-political conflict data...
                </div>
                <div id="inter-intra-chart" style="display: none;">
                    <!-- Chart will be inserted here by D3.js -->
                </div>
                <div class="chart-caption">
                    Each region displays two grouped bars showing the percentage distribution of conflict types, with subtypes color-coded within each category.
                </div>
            </section>

            <!-- Page Description -->
            <section class="viz-description" style="margin-top: 3rem;">
                <h2>Top Regions by Conflict Frequency per Decade</h2>
                <p>
                    This visualization explores how global conflicts have evolved across different regions over time. 
                    By analyzing historical war data from 1810 onwards, we can identify which regions experienced 
                    the highest concentration of conflicts in each decade.
                </p>
                <p>
                    The stacked bar chart shows the number of conflicts among the top three most 
                    conflict-prone regions in each 10-year period. This approach reveals shifting patterns of global 
                    instability and helps identify periods of regional concentration versus global dispersion of conflicts.
                </p>
                
                <div class="chart-info">
                    <p><strong>Data Source:</strong> Historical war database spanning from 1810 to present</p>
                    <p><strong>Methodology:</strong> Conflicts are grouped by primary location and 10-year intervals</p>
                    <p><strong>Visualization:</strong> Interactive stacked bar chart with hover details</p>
                </div>
            </section>

            <!-- Chart Container -->
            <section class="visualization-container">
                <div id="loading" class="loading-message">
                    Loading conflict data and generating visualization...
                </div>
                <div id="chart-container" style="display: none;">
                    <!-- Chart will be inserted here by D3.js -->
                </div>
                <div class="chart-caption">
                    Each bar shows the number of conflicts for the top three regions experiencing conflicts in each decade, based on available war data.
                </div>
            </section>

            <!-- New Ethnic vs Nationalist Wars Analysis -->
            <section class="viz-description" style="margin-top: 3rem;">
                <h2>Ethnic vs Nationalist Wars by Region (1816-Present)</h2>
                <p>
                    This visualization analyzes the distribution of ethnic and nationalist conflicts across different regions 
                    throughout modern history. Using comprehensive historical war data, we examine how different types of internal conflicts 
                    have been distributed geographically over time.
                </p>
                <p>
                    The vertically stacked bar chart shows the proportion of ethnic wars (Type 6) versus nationalist wars (Type 4) 
                    for each region. Wars involving multiple regions are counted for all regions involved, providing insights 
                    into which regions experienced higher concentrations of specific conflict types across the entire historical period.
                </p>
                
                <div class="chart-info">
                    <p><strong>Ethnic Wars (Type 6):</strong> Internal conflicts based on ethnic, tribal, or clan divisions</p>
                    <p><strong>Nationalist Wars (Type 4):</strong> Wars of independence and national liberation movements</p>
                    <p><strong>Time Period:</strong> Complete historical coverage (1816-Present)</p>
                </div>
            </section>

            <!-- Ethnic vs Nationalist Chart Container -->
            <section class="visualization-container" style="margin-top: 2rem;">
                <div id="ethnic-nationalist-loading" class="loading-message">
                    Loading ethnic and nationalist war data...
                </div>
                <div id="ethnic-nationalist-chart" style="display: none;">
                    <!-- Chart will be inserted here by D3.js -->
                </div>
                <div class="chart-caption">
                    Each region shows the proportional distribution of ethnic vs nationalist wars, with interactive tooltips displaying specific war details.
                </div>
            </section>

            <!-- New War Duration Heatmap Analysis -->
            <section class="viz-description" style="margin-top: 3rem;">
                <h2>War Duration Heatmap by Region and Decade</h2>
                <p>
                    This interactive heatmap visualizes the sum of war durations across different regions and time periods. 
                    Each war's duration is calculated as the number of years it lasted and is split equally among all 
                    unique locations involved in the conflict.
                </p>
                <p>
                    The heatmap shows aggregated war durations by region and decade, where each war is assigned to the 
                    decade based on its start year. Wars spanning multiple locations contribute proportionally to each 
                    affected region, providing insights into the intensity and geographical distribution of prolonged conflicts.
                </p>
                
                <div class="chart-info">
                    <p><strong>Duration Calculation:</strong> End year - Start year + 1, split equally among unique locations</p>
                    <p><strong>Region Mapping:</strong> Locations mapped to canonical regions; unmapped locations assigned to "Other"</p>
                    <p><strong>Time Binning:</strong> Wars grouped by start decade (e.g., 1810s, 1820s, etc.)</p>
                    <p><strong>Interactive Features:</strong> Hover for detailed war information and duration contributions</p>
                </div>
            </section>

            <!-- War Duration Heatmap Container -->
            <section class="visualization-container" style="margin-top: 2rem;">
                <div id="region-start-duration-heatmap-loading" class="loading-message">
                    Loading war duration heatmap data...
                </div>
                <div id="region-start-duration-heatmap" class="chart-container" style="display: none;">
                    <!-- Heatmap will be inserted here by D3.js -->
                </div>
                <div class="chart-caption">
                    Each cell represents the total allocated war duration (in years) for a specific region and decade, with interactive tooltips showing contributing wars.
                </div>
            </section>

        </div>
    </div>

    <script>
        // Regional Conflicts Visualization
        class RegionalConflictsChart {
            constructor() {
                this.data = [];
                this.processedData = [];
                this.svg = null;
                this.tooltip = null;
                this.colorScale = null;
                this.regions = [];
                
                // Chart dimensions - responsive
                this.setDimensions();
                
            }
            
            setDimensions() {
                // Responsive dimensions based on screen size
                const containerWidth = Math.min(window.innerWidth - 100, 900);
                const isMobile = window.innerWidth < 768;
                
                this.margin = isMobile 
                    ? { top: 40, right: 20, bottom: 100, left: 60 }
                    : { top: 60, right: 150, bottom: 80, left: 80 };
                    
                this.width = containerWidth - this.margin.left - this.margin.right;
                this.height = isMobile ? 400 : 500;
                this.height = this.height - this.margin.top - this.margin.bottom;
                
                this.init();
            }

            async init() {
                try {
                    // Load and process data
                    await this.loadData();
                    this.processData();
                    this.createVisualization();
                    this.hideLoading();
                } catch (error) {
                    console.error('Error initializing chart:', error);
                    document.getElementById('loading').innerHTML = 'Error loading data. Please try again.';
                }
            }

            async loadData() {
                // Load CSV data
                this.data = await d3.csv('WarList.csv');
                console.log('Loaded', this.data.length, 'records');
            }

            processData() {
                // Clean and process the data
                const processedWars = this.data
                    .filter(d => d['War Name'] && d['Time Span'] && d['Locations'])
                    .map(d => this.cleanWarData(d))
                    .filter(d => d.startYear >= 1810); // Filter from 1810 onwards

                // Group by decades and count conflicts per region
                const decades = this.groupByDecades(processedWars);
                
                // Get top 3 regions per decade with counts
                this.processedData = this.getTop3RegionsPerDecade(decades);
                
                // Get all unique regions for color scale
                this.regions = [...new Set(this.processedData.flatMap(d => d.regions.map(r => r.region)))];
                
                // Create color scale
                this.createColorScale();
                
                console.log('Processed data:', this.processedData);
            }

            cleanWarData(war) {
                // Extract start year from time span
                const timeSpan = war['Time Span'];
                const startYear = parseInt(timeSpan.split('-')[0]);
                
                // Clean location names - remove parenthetical details and split multiple locations
                const locations = war['Locations']
                    .split(',')
                    .map(loc => loc.trim())
                    .map(loc => loc.replace(/\s*\([^)]*\)/g, '')) // Remove parenthetical content
                    .map(loc => this.normalizeCountryName(loc))
                    .filter(loc => loc.length > 0);

                return {
                    warName: war['War Name'],
                    startYear: startYear,
                    locations: locations,
                    primaryLocation: locations[0] // Use first location as primary
                };
            }

            normalizeCountryName(name) {
                // Normalize country/region names for consistency
                const normalized = name.trim();
                
                // Country name mappings for consistency
                const mappings = {
                    'United States of America': 'United States',
                    'United Kingdom': 'Britain',
                    'Russia': 'Russia/USSR',
                    'USSR': 'Russia/USSR',
                    'Soviet Union': 'Russia/USSR',
                    'Democratic Republic of the Congo': 'Congo',
                    'Congo, Dem. Rep.': 'Congo',
                    'Yemen Arab Republic': 'Yemen',
                    'Yemen People\'s Republic': 'Yemen',
                    'North Korea': 'Korea',
                    'South Korea': 'Korea',
                    'Bosnia and Herzegovina': 'Bosnia',
                    'Czech Republic': 'Czechoslovakia',
                    'Slovakia': 'Czechoslovakia',
                    'Serbia': 'Yugoslavia',
                    'Croatia': 'Yugoslavia',
                    'Slovenia': 'Yugoslavia'
                };

                return mappings[normalized] || normalized;
            }

            groupByDecades(wars) {
                const decades = {};
                
                wars.forEach(war => {
                    const decade = Math.floor(war.startYear / 10) * 10;
                    const decadeKey = `${decade}-${decade + 9}`;
                    
                    if (!decades[decadeKey]) {
                        decades[decadeKey] = [];
                    }
                    
                    decades[decadeKey].push(war);
                });
                
                return decades;
            }

            getTop3RegionsPerDecade(decades) {
                const result = [];
                
                Object.keys(decades).sort().forEach(decadeKey => {
                    const wars = decades[decadeKey];
                    
                    // Count conflicts per region (using primary location)
                    const regionCounts = {};
                    wars.forEach(war => {
                        const region = this.getRegionFromCountry(war.primaryLocation);
                        regionCounts[region] = (regionCounts[region] || 0) + 1;
                    });
                    
                    // Get top 3 regions
                    const sortedRegions = Object.entries(regionCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3);
                    
                    // Calculate total conflicts for percentage calculation
                    const totalConflicts = wars.length;
                    
                    // Create region data with percentages
                    const regionData = sortedRegions.map(([region, count]) => ({
                        region: region,
                        count: count,
                        percentage: (count / totalConflicts) * 100
                    }));
                    
                    result.push({
                        decade: decadeKey,
                        totalConflicts: totalConflicts,
                        regions: regionData
                    });
                });
                
                return result;
            }

            getRegionFromCountry(country) {
                // Map countries to broader regions based on the comprehensive mapping
                const regionMap = {
                    // Europe
                    'Albania': 'Europe',
                    'Austria': 'Europe',
                    'Austria-Hungary': 'Europe',
                    'Baden': 'Europe',
                    'Bavaria': 'Europe',
                    'Belgium': 'Europe',
                    'Bosnia and Herzegovina': 'Europe',
                    'Bosnia': 'Europe',
                    'Bulgaria': 'Europe',
                    'Croatia': 'Europe',
                    'Cyprus': 'Europe',
                    'Czech Rep': 'Europe',
                    'Czech Republic': 'Europe',
                    'Czechoslovakia': 'Europe',
                    'Denmark': 'Europe',
                    'Estonia': 'Europe',
                    'Finland': 'Europe',
                    'France': 'Europe',
                    'Germany': 'Europe',
                    'Great Britain': 'Europe',
                    'Britain': 'Europe',
                    'Greece': 'Europe',
                    'Hanover': 'Europe',
                    'Hesse Electoral': 'Europe',
                    'Hesse Grand Ducal': 'Europe',
                    'Hungary': 'Europe',
                    'Iceland': 'Europe',
                    'Italy': 'Europe',
                    'Latvia': 'Europe',
                    'Lithuania': 'Europe',
                    'Luxembourg': 'Europe',
                    'Macedonia': 'Europe',
                    'Mecklenburg Schwerin': 'Europe',
                    'Modena': 'Europe',
                    'Netherlands': 'Europe',
                    'Norway': 'Europe',
                    'Papal States': 'Europe',
                    'Poland': 'Europe',
                    'Portugal': 'Europe',
                    'Romania': 'Europe',
                    'Russia': 'Europe',
                    'Russia/USSR': 'Europe',
                    'Saxony': 'Europe',
                    'Slovakia': 'Europe',
                    'Spain': 'Europe',
                    'Sweden': 'Europe',
                    'Tuscany': 'Europe',
                    'Two Sicilies': 'Europe',
                    'Ukraine': 'Europe',
                    'United Kingdom': 'Europe',
                    'Wuerttemburg': 'Europe',
                    'Yugoslavia': 'Europe',

                    // Asia
                    'Aceh Sultanate': 'Asia',
                    'Armenia': 'Asia',
                    'Azerbaijan': 'Asia',
                    'Balinese Kingdom of Lombok': 'Asia',
                    'Bangladesh': 'Asia',
                    'Bhutan': 'Asia',
                    'Cambodia': 'Asia',
                    'China': 'Asia',
                    'Georgia': 'Asia',
                    'India': 'Asia',
                    'Indonesia': 'Asia',
                    'Japan': 'Asia',
                    'Kazakhstan': 'Asia',
                    'Khanate of Kiva': 'Asia',
                    'Khanates of Kokand and Bokhara': 'Asia',
                    'Kingdom of Bharatpur': 'Asia',
                    'Kingdom of Lahore': 'Asia',
                    'Kingdom of Sindh': 'Asia',
                    'Korea': 'Asia',
                    'North Korea': 'Asia',
                    'South Korea': 'Asia',
                    'Kyrgystan': 'Asia',
                    'Laos': 'Asia',
                    'Malaysia': 'Asia',
                    'Maratha Empire': 'Asia',
                    'Mongolia': 'Asia',
                    'Myanmar': 'Asia',
                    'Nepal': 'Asia',
                    'Pakistan': 'Asia',
                    'Philippines': 'Asia',
                    'Principality of Jammu': 'Asia',
                    'Republic of Vietnam': 'Asia',
                    'Sri Lanka': 'Asia',
                    'Taiwan': 'Asia',
                    'Tajikistan': 'Asia',
                    'Thailand': 'Asia',
                    'Tibet': 'Asia',
                    'Turkmenistan': 'Asia',
                    'Uzbekistan': 'Asia',
                    'Vietnam': 'Asia',

                    // Middle East
                    'Afghanistan': 'Middle East',
                    'Egypt': 'Middle East',
                    'Iran': 'Middle East',
                    'Iraq': 'Middle East',
                    'Israel': 'Middle East',
                    'Jordan': 'Middle East',
                    'Kuwait': 'Middle East',
                    'Lebanon': 'Middle East',
                    'Oman': 'Middle East',
                    'Qatar': 'Middle East',
                    'Saudi Arabia': 'Middle East',
                    'Syria': 'Middle East',
                    'Turkey': 'Middle East',
                    'United Arab Emirates': 'Middle East',
                    'Yemen': 'Middle East',
                    'Yemen Arab Republic': 'Middle East',
                    'Yemen People\'s Republic': 'Middle East',

                    // Africa
                    'Algeria': 'Africa',
                    'Angola': 'Africa',
                    'Ashanti Kingdom': 'Africa',
                    'Bambara Empire': 'Africa',
                    'Benin': 'Africa',
                    'Benin Empire': 'Africa',
                    'Boer state': 'Africa',
                    'Bornu': 'Africa',
                    'Buganda': 'Africa',
                    'Burundi': 'Africa',
                    'Cameroon': 'Africa',
                    'Chad': 'Africa',
                    'Congo': 'Africa',
                    'Dem. Rep.': 'Africa',
                    'Democratic Republic of the Congo': 'Africa',
                    'Emirates of Kano': 'Africa',
                    'Eritrea': 'Africa',
                    'Ethiopia': 'Africa',
                    'Ghana': 'Africa',
                    'Guinea': 'Africa',
                    'Guinea-Bissau': 'Africa',
                    'Kenya': 'Africa',
                    'Kingdom of Waalo': 'Africa',
                    'Lesotho': 'Africa',
                    'Liberia': 'Africa',
                    'Libya': 'Africa',
                    'Madagascar': 'Africa',
                    'Mali': 'Africa',
                    'Mandingo Empire': 'Africa',
                    'Mauritania': 'Africa',
                    'Morocco': 'Africa',
                    'Mozambique': 'Africa',
                    'Namibia': 'Africa',
                    'Ndebele Kingdom': 'Africa',
                    'Nigeria': 'Africa',
                    'Orange Free State': 'Africa',
                    'Oyo': 'Africa',
                    'Rwanda': 'Africa',
                    'Sanusi Empire': 'Africa',
                    'Senegal': 'Africa',
                    'Sierra Leone': 'Africa',
                    'Sokoto': 'Africa',
                    'Somalia': 'Africa',
                    'South Africa': 'Africa',
                    'South African Republic': 'Africa',
                    'Sudan': 'Africa',
                    'Tanzania': 'Africa',
                    'Transvaal': 'Africa',
                    'Tukolor Empire': 'Africa',
                    'Tunisia': 'Africa',
                    'Uganda': 'Africa',
                    'Xhosa': 'Africa',
                    'Zimbabwe': 'Africa',
                    'Zulu': 'Africa',
                    'Zulu Kingdom': 'Africa',

                    // North America
                    'Canada': 'North America',
                    'Cuba': 'North America',
                    'Dominican Republic': 'North America',
                    'Haiti': 'North America',
                    'Mexico': 'North America',
                    'United States': 'North America',
                    'United States of America': 'North America',

                    // Central America
                    'Costa Rica': 'Central America',
                    'El Salvador': 'Central America',
                    'Guatemala': 'Central America',
                    'Honduras': 'Central America',
                    'Nicaragua': 'Central America',

                    // South America
                    'Argentina': 'South America',
                    'Bolivia': 'South America',
                    'Brazil': 'South America',
                    'Chile': 'South America',
                    'Colombia': 'South America',
                    'Ecuador': 'South America',
                    'Paraguay': 'South America',
                    'Peru': 'South America',
                    'Peru-Bolivia': 'South America',
                    'Uruguay': 'South America',
                    'Venezuela': 'South America',

                    // Oceania
                    'Australia': 'Oceania',
                    'New Zealand': 'Oceania'
                };

                return regionMap[country] || 'Other';
            }

            createColorScale() {
                // Create a color scale for regions using the website's color palette
                const colors = [
                    '#001219', // Primary blue
                    '#005F73', // Primary purple
                    '#0A9396', // Light pink
                    '#94D2BD', // Red
                    '#E9D8A6', // Light blue
                    '#EE9B00', // Green
                    '#CA6702', // Pink
                    '#BB3E03', // Yellow
                    '#AE2012', // Light purple
                    '#841317'  // Blue
                    
                ];
                
                this.colorScale = d3.scaleOrdinal()
                    .domain(this.regions)
                    .range(['#002D40','#991332','#FF7747','#FFC76E','#0097AB']);
            }

            createVisualization() {
                // Create SVG
                const container = d3.select('#chart-container');
                
                // Calculate total height including mobile legend space
                const isMobile = window.innerWidth < 768;
                const totalHeight = this.height + this.margin.top + this.margin.bottom + (isMobile ? 60 : 0);
                
                this.svg = container
                    .append('svg')
                    .attr('width', this.width + this.margin.left + this.margin.right)
                    .attr('height', totalHeight)
                    .attr('class', 'chart-svg')
                    .attr('viewBox', `0 0 ${this.width + this.margin.left + this.margin.right} ${totalHeight}`)
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                const g = this.svg.append('g')
                    .attr('transform', `translate(${this.margin.left},${this.margin.top})`);

                // Create tooltip
                this.tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip');

                // Create scales
                const xScale = d3.scaleBand()
                    .domain(this.processedData.map(d => d.decade))
                    .range([0, this.width])
                    .padding(0.1);

                // Calculate max count for Y-scale domain
                const maxCount = d3.max(this.processedData, d => 
                    d3.sum(d.regions, r => r.count)
                );

                const yScale = d3.scaleLinear()
                    .domain([0, maxCount]) // Count scale
                    .range([this.height, 0]);

                // Create and draw bars
                this.drawBars(g, xScale, yScale);
                
                // Create axes
                this.drawAxes(g, xScale, yScale);
                
                // Create legend
                this.drawLegend(g);
                
                // Add title
                this.addTitle(g);
            }

            drawBars(g, xScale, yScale) {
                const barGroups = g.selectAll('.bar-group')
                    .data(this.processedData)
                    .enter()
                    .append('g')
                    .attr('class', 'bar-group')
                    .attr('transform', d => `translate(${xScale(d.decade)}, 0)`);

                // Stack the data for each decade
                barGroups.each((d, i, nodes) => {
                    const group = d3.select(nodes[i]);
                    let yOffset = yScale(0);
                    
                    d.regions.forEach((region, index) => {
                        const segmentHeight = yScale(0) - yScale(region.count);
                        
                        group.append('rect')
                            .attr('class', 'bar-segment')
                            .attr('x', 0)
                            .attr('y', yOffset - segmentHeight)
                            .attr('width', xScale.bandwidth())
                            .attr('height', segmentHeight)
                            .attr('fill', this.colorScale(region.region))
                            .on('mouseover', (event) => {
                                this.showTooltip(event, region, d.decade, d.totalConflicts);
                            })
                            .on('mouseout', () => {
                                this.hideTooltip();
                            });
                        
                        yOffset -= segmentHeight;
                    });
                });
            }

            drawAxes(g, xScale, yScale) {
                // X-axis
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0, ${this.height})`)
                    .call(d3.axisBottom(xScale))
                    .selectAll('text')
                    .style('text-anchor', 'end')
                    .attr('dx', '-.8em')
                    .attr('dy', '.15em')
                    .attr('transform', 'rotate(-45)');

                // Y-axis
                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(yScale));

                // Axis labels
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('x', this.width / 2)
                    .attr('y', this.height + 70)
                    .style('text-anchor', 'middle')
                    .text('Decade');

                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', 'rotate(-90)')
                    .attr('x', -this.height / 2)
                    .attr('y', -50)
                    .style('text-anchor', 'middle')
                    .text('Number of Conflicts');
            }

            drawLegend(g) {
                const isMobile = window.innerWidth < 768;
                
                if (isMobile) {
                    // Mobile legend - horizontal layout below chart
                    const legend = g.append('g')
                        .attr('class', 'legend')
                        .attr('transform', `translate(0, ${this.height + 60})`);

                    const legendItems = legend.selectAll('.legend-item')
                        .data(this.regions.slice(0, 6)) // Limit to top 6 regions on mobile
                        .enter()
                        .append('g')
                        .attr('class', 'legend-item')
                        .attr('transform', (d, i) => {
                            const col = i % 3;
                            const row = Math.floor(i / 3);
                            return `translate(${col * (this.width / 3)}, ${row * 20})`;
                        });

                    legendItems.append('rect')
                        .attr('class', 'legend-rect')
                        .attr('width', 12)
                        .attr('height', 12)
                        .attr('fill', d => this.colorScale(d));

                    legendItems.append('text')
                        .attr('x', 16)
                        .attr('y', 10)
                        .text(d => d)
                        .style('font-size', '10px')
                        .style('fill', '#333');
                } else {
                    // Desktop legend - vertical layout on right side
                    const legend = g.append('g')
                        .attr('class', 'legend')
                        .attr('transform', `translate(${this.width + 20}, 20)`);

                    const legendItems = legend.selectAll('.legend-item')
                        .data(this.regions)
                        .enter()
                        .append('g')
                        .attr('class', 'legend-item')
                        .attr('transform', (d, i) => `translate(0, ${i * 25})`);

                    legendItems.append('rect')
                        .attr('class', 'legend-rect')
                        .attr('width', 15)
                        .attr('height', 15)
                        .attr('fill', d => this.colorScale(d));

                    legendItems.append('text')
                        .attr('x', 20)
                        .attr('y', 12)
                        .text(d => d)
                        .style('font-size', '12px')
                        .style('fill', '#333');
                }
            }

            addTitle(g) {
                g.append('text')
                    .attr('class', 'chart-title')
                    .attr('x', this.width / 2)
                    .attr('y', -30)
                    .style('text-anchor', 'middle')
                    .style('font-size', '18px')
                    .style('font-weight', 'bold')
                    .style('fill', '#2c3e50')
                    .text('Top 3 Regions by Number of Conflicts per Decade');
            }

            showTooltip(event, region, decade, totalConflicts) {
                this.tooltip.transition()
                    .duration(200)
                    .style('opacity', .9);
                
                this.tooltip.html(`
                    <strong>${region.region}</strong><br/>
                    Decade: ${decade}<br/>
                    Conflicts: ${region.count}<br/>
                    Total in decade: ${totalConflicts}<br/>
                    Percentage: ${region.percentage.toFixed(1)}%
                `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            }

            hideTooltip() {
                this.tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chart-container').style.display = 'block';
            }
        }

        // Inter-political vs Intra-political Wars Visualization
        class InterIntraChart {
            constructor() {
                this.data = [];
                this.processedData = [];
                this.svg = null;
                this.tooltip = null;
                this.colorScale = null;
                
                // Chart dimensions - responsive
                this.setDimensions();
            }
            
            setDimensions() {
                // Responsive dimensions based on screen size
                const containerWidth = Math.min(window.innerWidth - 100, 1100);
                const isMobile = window.innerWidth < 768;
                
                this.margin = isMobile 
                    ? { top: 40, right: 20, bottom: 140, left: 80 }
                    : { top: 80, right: 250, bottom: 100, left: 100 };
                    
                this.width = containerWidth - this.margin.left - this.margin.right;
                this.height = isMobile ? 500 : 650;
                this.height = this.height - this.margin.top - this.margin.bottom;
                
                this.init();
            }

            async init() {
                try {
                    console.log('Starting InterIntraChart initialization...');
                    await this.loadData();
                    console.log('Data loaded successfully, processing...');
                    this.processData();
                    console.log('Data processed successfully, creating visualization...');
                    this.createVisualization();
                    console.log('InterIntra visualization created successfully');
                    this.hideLoading();
                } catch (error) {
                    console.error('Error initializing inter-intra chart:', error);
                    document.getElementById('inter-intra-loading').innerHTML = 'Error loading data. Please try again.';
                }
            }

            async loadData() {
                this.data = await d3.csv('WarList.csv');
                console.log('Loaded inter-intra data:', this.data.length, 'wars');
            }

            processData() {
                // Filter and clean wars data
                const cleanWars = this.data
                    .filter(d => d['War Name'] && d['Time Span'] && d['Locations'] && d['Type Number'])
                    .map(d => this.cleanWarData(d))
                    .filter(d => d.startYear >= 1810 && d.typeNumber >= 1 && d.typeNumber <= 6);

                console.log('Clean wars count:', cleanWars.length);

                // Group wars by region and type category
                const regionData = {};
                
                cleanWars.forEach(war => {
                    war.regions.forEach(region => {
                        if (!regionData[region]) {
                            regionData[region] = {
                                inter: { 1: [], 2: [] },
                                intra: { 3: [], 4: [], 5: [], 6: [] }
                            };
                        }
                        
                        if (war.typeNumber >= 1 && war.typeNumber <= 2) {
                            regionData[region].inter[war.typeNumber].push(war);
                        } else if (war.typeNumber >= 3 && war.typeNumber <= 6) {
                            regionData[region].intra[war.typeNumber].push(war);
                        }
                    });
                });

                // Convert to array format for visualization
                this.processedData = Object.entries(regionData)
                    .map(([region, data]) => {
                        const interCount = Object.values(data.inter).flat().length;
                        const intraCount = Object.values(data.intra).flat().length;
                        const total = interCount + intraCount;
                        
                        if (total === 0) return null;

                        // Calculate percentages and type distributions
                        const interPercentage = (interCount / total) * 100;
                        const intraPercentage = (intraCount / total) * 100;

                        // Calculate subtype distributions within each category
                        const interSubtypes = {};
                        const intraSubtypes = {};
                        
                        [1, 2].forEach(type => {
                            const count = data.inter[type].length;
                            interSubtypes[type] = {
                                count: count,
                                percentage: interCount > 0 ? (count / interCount) * 100 : 0,
                                wars: data.inter[type]
                            };
                        });

                        [3, 4, 5, 6].forEach(type => {
                            const count = data.intra[type].length;
                            intraSubtypes[type] = {
                                count: count,
                                percentage: intraCount > 0 ? (count / intraCount) * 100 : 0,
                                wars: data.intra[type]
                            };
                        });

                        return {
                            region: region,
                            interCount: interCount,
                            intraCount: intraCount,
                            totalCount: total,
                            interPercentage: interPercentage,
                            intraPercentage: intraPercentage,
                            interSubtypes: interSubtypes,
                            intraSubtypes: intraSubtypes
                        };
                    })
                    .filter(d => d !== null)
                    .sort((a, b) => b.totalCount - a.totalCount); // Sort by total conflicts

                console.log('Processed inter-intra data:', this.processedData);
                
                // Create color scales
                this.createColorScale();
            }

            cleanWarData(war) {
                const timeSpan = war['Time Span'];
                const startYear = parseInt(timeSpan.split('-')[0]);
                const typeNumber = parseInt(war['Type Number']);
                
                // Parse locations and map to regions
                const locations = war['Locations']
                    .split(',')
                    .map(loc => loc.trim())
                    .map(loc => loc.replace(/\s*\([^)]*\)/g, ''))
                    .filter(loc => loc.length > 0);

                const regions = [...new Set(locations.map(loc => 
                    this.getRegionFromCountry(loc)
                ))].filter(region => region !== 'Other');

                return {
                    warName: war['War Name'],
                    startYear: startYear,
                    typeNumber: typeNumber,
                    locations: locations,
                    regions: regions.length > 0 ? regions : ['Other'],
                    timeSpan: timeSpan
                };
            }

            getRegionFromCountry(country) {
                // Use the same comprehensive region mapping as the other charts
                const regionMap = {
                    // Europe
                    'Albania': 'Europe', 'Austria': 'Europe', 'Austria-Hungary': 'Europe', 'Baden': 'Europe', 'Bavaria': 'Europe',
                    'Belgium': 'Europe', 'Bosnia and Herzegovina': 'Europe', 'Bosnia': 'Europe', 'Bulgaria': 'Europe', 'Croatia': 'Europe',
                    'Cyprus': 'Europe', 'Czech Rep': 'Europe', 'Czech Republic': 'Europe', 'Czechoslovakia': 'Europe', 'Denmark': 'Europe',
                    'Estonia': 'Europe', 'Finland': 'Europe', 'France': 'Europe', 'Germany': 'Europe', 'Great Britain': 'Europe',
                    'Britain': 'Europe', 'Greece': 'Europe', 'Hanover': 'Europe', 'Hesse Electoral': 'Europe', 'Hesse Grand Ducal': 'Europe',
                    'Hungary': 'Europe', 'Iceland': 'Europe', 'Italy': 'Europe', 'Latvia': 'Europe', 'Lithuania': 'Europe',
                    'Luxembourg': 'Europe', 'Macedonia': 'Europe', 'Mecklenburg Schwerin': 'Europe', 'Modena': 'Europe', 'Netherlands': 'Europe',
                    'Norway': 'Europe', 'Papal States': 'Europe', 'Poland': 'Europe', 'Portugal': 'Europe', 'Romania': 'Europe',
                    'Russia': 'Europe', 'Russia/USSR': 'Europe', 'Saxony': 'Europe', 'Slovakia': 'Europe', 'Spain': 'Europe',
                    'Sweden': 'Europe', 'Tuscany': 'Europe', 'Two Sicilies': 'Europe', 'Ukraine': 'Europe', 'United Kingdom': 'Europe',
                    'Wuerttemburg': 'Europe', 'Yugoslavia': 'Europe',

                    // Asia
                    'Aceh Sultanate': 'Asia', 'Armenia': 'Asia', 'Azerbaijan': 'Asia', 'Balinese Kingdom of Lombok': 'Asia',
                    'Bangladesh': 'Asia', 'Bhutan': 'Asia', 'Cambodia': 'Asia', 'China': 'Asia', 'Georgia': 'Asia', 'India': 'Asia',
                    'Indonesia': 'Asia', 'Japan': 'Asia', 'Kazakhstan': 'Asia', 'Khanate of Kiva': 'Asia', 'Khanates of Kokand and Bokhara': 'Asia',
                    'Kingdom of Bharatpur': 'Asia', 'Kingdom of Lahore': 'Asia', 'Kingdom of Sindh': 'Asia', 'Korea': 'Asia',
                    'North Korea': 'Asia', 'South Korea': 'Asia', 'Kyrgystan': 'Asia', 'Laos': 'Asia', 'Malaysia': 'Asia',
                    'Maratha Empire': 'Asia', 'Mongolia': 'Asia', 'Myanmar': 'Asia', 'Nepal': 'Asia', 'Pakistan': 'Asia',
                    'Philippines': 'Asia', 'Principality of Jammu': 'Asia', 'Republic of Vietnam': 'Asia', 'Sri Lanka': 'Asia',
                    'Taiwan': 'Asia', 'Tajikistan': 'Asia', 'Thailand': 'Asia', 'Tibet': 'Asia', 'Turkmenistan': 'Asia',
                    'Uzbekistan': 'Asia', 'Vietnam': 'Asia',

                    // Middle East
                    'Afghanistan': 'Middle East', 'Egypt': 'Middle East', 'Iran': 'Middle East', 'Iraq': 'Middle East',
                    'Israel': 'Middle East', 'Jordan': 'Middle East', 'Kuwait': 'Middle East', 'Lebanon': 'Middle East',
                    'Oman': 'Middle East', 'Qatar': 'Middle East', 'Saudi Arabia': 'Middle East', 'Syria': 'Middle East',
                    'Turkey': 'Middle East', 'United Arab Emirates': 'Middle East', 'Yemen': 'Middle East',
                    'Yemen Arab Republic': 'Middle East', 'Yemen People\'s Republic': 'Middle East',

                    // Africa
                    'Algeria': 'Africa', 'Angola': 'Africa', 'Ashanti Kingdom': 'Africa', 'Bambara Empire': 'Africa',
                    'Benin': 'Africa', 'Benin Empire': 'Africa', 'Boer state': 'Africa', 'Bornu': 'Africa', 'Buganda': 'Africa',
                    'Burundi': 'Africa', 'Cameroon': 'Africa', 'Chad': 'Africa', 'Congo': 'Africa', 'Dem. Rep.': 'Africa',
                    'Democratic Republic of the Congo': 'Africa', 'Emirates of Kano': 'Africa', 'Eritrea': 'Africa', 'Ethiopia': 'Africa',
                    'Ghana': 'Africa', 'Guinea': 'Africa', 'Guinea-Bissau': 'Africa', 'Kenya': 'Africa', 'Kingdom of Waalo': 'Africa',
                    'Lesotho': 'Africa', 'Liberia': 'Africa', 'Libya': 'Africa', 'Madagascar': 'Africa', 'Mali': 'Africa',
                    'Mandingo Empire': 'Africa', 'Mauritania': 'Africa', 'Morocco': 'Africa', 'Mozambique': 'Africa', 'Namibia': 'Africa',
                    'Ndebele Kingdom': 'Africa', 'Nigeria': 'Africa', 'Orange Free State': 'Africa', 'Oyo': 'Africa', 'Rwanda': 'Africa',
                    'Sanusi Empire': 'Africa', 'Senegal': 'Africa', 'Sierra Leone': 'Africa', 'Sokoto': 'Africa', 'Somalia': 'Africa',
                    'South Africa': 'Africa', 'South African Republic': 'Africa', 'Sudan': 'Africa', 'Tanzania': 'Africa',
                    'Transvaal': 'Africa', 'Tukolor Empire': 'Africa', 'Tunisia': 'Africa', 'Uganda': 'Africa', 'Xhosa': 'Africa',
                    'Zimbabwe': 'Africa', 'Zulu': 'Africa', 'Zulu Kingdom': 'Africa',

                    // North America
                    'Canada': 'North America', 'Cuba': 'North America', 'Dominican Republic': 'North America',
                    'Haiti': 'North America', 'Mexico': 'North America', 'United States': 'North America',
                    'United States of America': 'North America',

                    // Central America
                    'Costa Rica': 'Central America', 'El Salvador': 'Central America', 'Guatemala': 'Central America',
                    'Honduras': 'Central America', 'Nicaragua': 'Central America',

                    // South America
                    'Argentina': 'South America', 'Bolivia': 'South America', 'Brazil': 'South America',
                    'Chile': 'South America', 'Colombia': 'South America', 'Ecuador': 'South America',
                    'Paraguay': 'South America', 'Peru': 'South America', 'Peru-Bolivia': 'South America',
                    'Uruguay': 'South America', 'Venezuela': 'South America',

                    // Oceania
                    'Australia': 'Oceania', 'New Zealand': 'Oceania'
                };

                return regionMap[country] || 'Other';
            }

            createColorScale() {
                // Define color scales for different conflict types
                const typeColors = {
                    1: '#001219', // Inter-political: War of conquest - darkest blue
                    2: '#005F73', // Inter-political: Balance of power - medium blue
                    3: '#0A9396', // Intra-political: Civil war (secessionist, non-nationalist) - teal
                    4: '#94D2BD', // Intra-political: Civil war (secessionist, nationalist) - light teal
                    5: '#E9D8A6', // Intra-political: Civil war (non-secessionist, ethnic) - beige
                    6: '#EE9B00'  // Intra-political: Civil war (non-secessionist, non-ethnic) - orange
                };
                
                this.colorScale = d3.scaleOrdinal()
                    .domain([1, 2, 3, 4, 5, 6])
                    .range([typeColors[1], typeColors[2], typeColors[3], typeColors[4], typeColors[5], typeColors[6]]);
            }

            createVisualization() {
                const container = d3.select('#inter-intra-chart');
                
                // Create SVG
                const totalHeight = this.height + this.margin.top + this.margin.bottom;
                
                this.svg = container
                    .append('svg')
                    .attr('width', this.width + this.margin.left + this.margin.right)
                    .attr('height', totalHeight)
                    .attr('viewBox', `0 0 ${this.width + this.margin.left + this.margin.right} ${totalHeight}`)
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                const g = this.svg.append('g')
                    .attr('transform', `translate(${this.margin.left},${this.margin.top})`);

                // Create tooltip
                this.tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('z-index', '1001');

                // Create scales
                const xScale = d3.scaleBand()
                    .domain(this.processedData.map(d => d.region))
                    .range([0, this.width])
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, 100]) // Percentage scale
                    .range([this.height, 0]);

                // Create grouped bars
                this.drawGroupedBars(g, xScale, yScale);
                
                // Create axes
                this.drawAxes(g, xScale, yScale);
                
                // Create legend
                this.drawLegend(g);
                
                // Add title
                this.addTitle(g);
            }

            drawGroupedBars(g, xScale, yScale) {
                const barGroups = g.selectAll('.inter-intra-bar-group')
                    .data(this.processedData)
                    .enter()
                    .append('g')
                    .attr('class', 'inter-intra-bar-group')
                    .attr('transform', d => `translate(${xScale(d.region)}, 0)`);

                const barWidth = xScale.bandwidth() * 0.4; // Each bar takes 40% of the band
                const barGap = xScale.bandwidth() * 0.1; // 10% gap between bars

                barGroups.each((d, i, nodes) => {
                    const group = d3.select(nodes[i]);
                    
                    // Draw Inter-political bar (left side)
                    if (d.interPercentage > 0) {
                        this.drawStackedBar(group, 0, d, 'inter', barWidth, yScale);
                    }
                    
                    // Draw Intra-political bar (right side)  
                    if (d.intraPercentage > 0) {
                        this.drawStackedBar(group, barWidth + barGap, d, 'intra', barWidth, yScale);
                    }
                });
            }

            drawStackedBar(group, xOffset, regionData, barType, barWidth, yScale) {
                const subtypes = barType === 'inter' ? regionData.interSubtypes : regionData.intraSubtypes;
                const totalPercentage = barType === 'inter' ? regionData.interPercentage : regionData.intraPercentage;
                
                let yOffset = yScale(0);
                
                Object.entries(subtypes).forEach(([typeNum, typeData]) => {
                    if (typeData.count > 0) {
                        const segmentHeight = (typeData.percentage / 100) * (yScale(0) - yScale(totalPercentage));
                        
                        group.append('rect')
                            .attr('class', `bar-segment type-${typeNum}`)
                            .attr('x', xOffset)
                            .attr('y', yOffset - segmentHeight)
                            .attr('width', barWidth)
                            .attr('height', segmentHeight)
                            .attr('fill', this.colorScale(typeNum))
                            .style('cursor', 'pointer')
                            .on('mouseover', (event) => {
                                this.showTooltip(event, regionData, barType, typeNum, typeData);
                                // Highlight both bars of the region
                                group.selectAll('.bar-segment')
                                    .style('opacity', 0.7)
                                    .style('stroke', '#333')
                                    .style('stroke-width', '1px');
                            })
                            .on('mouseout', () => {
                                this.hideTooltip();
                                // Remove highlight
                                group.selectAll('.bar-segment')
                                    .style('opacity', 1)
                                    .style('stroke', 'none');
                            });
                        
                        yOffset -= segmentHeight;
                    }
                });
            }

            drawAxes(g, xScale, yScale) {
                // X-axis
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0, ${this.height})`)
                    .call(d3.axisBottom(xScale))
                    .selectAll('text')
                    .style('text-anchor', 'end')
                    .attr('dx', '-.8em')
                    .attr('dy', '.15em')
                    .attr('transform', 'rotate(-45)')
                    .style('font-size', '11px');

                // Y-axis
                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(yScale).tickFormat(d => d + '%'));

                // Axis labels
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('x', this.width / 2)
                    .attr('y', this.height + 80)
                    .style('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .text('Region');

                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', 'rotate(-90)')
                    .attr('x', -this.height / 2)
                    .attr('y', -60)
                    .style('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .text('Percentage of Total Regional Conflicts');
            }

            drawLegend(g) {
                const isMobile = window.innerWidth < 768;
                
                const legend = g.append('g')
                    .attr('class', 'legend')
                    .attr('transform', isMobile ? 
                        `translate(10, ${this.height + 100})` : 
                        `translate(${this.width + 20}, 20)`);

                // Legend data with descriptions
                const legendData = [
                    { type: 1, category: 'Inter-political', label: 'Type 1: War of conquest', color: this.colorScale(1) },
                    { type: 2, category: 'Inter-political', label: 'Type 2: Balance of power war', color: this.colorScale(2) },
                    { type: 3, category: 'Intra-political', label: 'Type 3: Civil war (secessionist, non-nationalist)', color: this.colorScale(3) },
                    { type: 4, category: 'Intra-political', label: 'Type 4: Civil war (secessionist, nationalist)', color: this.colorScale(4) },
                    { type: 5, category: 'Intra-political', label: 'Type 5: Civil war (non-secessionist, ethnic)', color: this.colorScale(5) },
                    { type: 6, category: 'Intra-political', label: 'Type 6: Civil war (non-secessionist, non-ethnic)', color: this.colorScale(6) }
                ];

                if (isMobile) {
                    // Mobile legend - more compact
                    legendData.forEach((d, i) => {
                        const legendItem = legend.append('g')
                            .attr('class', 'legend-item')
                            .attr('transform', `translate(0, ${i * 18})`);

                        legendItem.append('rect')
                            .attr('width', 12)
                            .attr('height', 12)
                            .attr('fill', d.color)
                            .attr('stroke', '#333')
                            .attr('stroke-width', 0.5);

                        legendItem.append('text')
                            .attr('x', 16)
                            .attr('y', 10)
                            .text(`Type ${d.type}`)
                            .style('font-size', '10px')
                            .style('fill', '#333');
                    });
                } else {
                    // Desktop legend - with category headers
                    let yOffset = 0;
                    let currentCategory = '';
                    
                    legendData.forEach((d, i) => {
                        if (d.category !== currentCategory) {
                            // Add category header
                            legend.append('text')
                                .attr('x', 0)
                                .attr('y', yOffset + 12)
                                .text(d.category)
                                .style('font-size', '14px')
                                .style('font-weight', 'bold')
                                .style('fill', '#333');
                            
                            yOffset += 25;
                            currentCategory = d.category;
                        }
                        
                        const legendItem = legend.append('g')
                            .attr('class', 'legend-item')
                            .attr('transform', `translate(15, ${yOffset})`);

                        legendItem.append('rect')
                            .attr('width', 15)
                            .attr('height', 15)
                            .attr('fill', d.color)
                            .attr('stroke', '#333')
                            .attr('stroke-width', 1);

                        legendItem.append('text')
                            .attr('x', 20)
                            .attr('y', 12)
                            .text(d.label)
                            .style('font-size', '11px')
                            .style('fill', '#333');
                        
                        yOffset += 20;
                    });
                }
            }

            addTitle(g) {
                g.append('text')
                    .attr('class', 'chart-title')
                    .attr('x', this.width / 2)
                    .attr('y', -50)
                    .style('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .style('font-weight', 'bold')
                    .style('fill', '#2c3e50')
                    .text('Inter-political vs. Intra-political Conflicts by Region');
                
                // Add subtitle
                g.append('text')
                    .attr('class', 'chart-subtitle')
                    .attr('x', this.width / 2)
                    .attr('y', -30)
                    .style('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .style('fill', '#666')
                    .text('Percentage distribution with conflict type breakdown');
            }

            showTooltip(event, regionData, barType, typeNum, typeData) {
                const typeNames = {
                    1: 'War of conquest',
                    2: 'Balance of power war',
                    3: 'Civil war (secessionist, non-nationalist)',
                    4: 'Civil war (secessionist, nationalist)',
                    5: 'Civil war (non-secessionist, ethnic)',
                    6: 'Civil war (non-secessionist, non-ethnic)'
                };

                const category = barType === 'inter' ? 'Inter-political' : 'Intra-political';
                const categoryPercentage = barType === 'inter' ? regionData.interPercentage : regionData.intraPercentage;
                
                let tooltipContent = `
                    <strong>${regionData.region}</strong><br/>
                    <strong>${category} Conflicts</strong><br/>
                    Category total: ${categoryPercentage.toFixed(1)}% of regional conflicts<br/>
                    <hr style="margin: 5px 0; border: 1px solid #ccc;">
                    <strong>Type ${typeNum}: ${typeNames[typeNum]}</strong><br/>
                    Wars: ${typeData.count} (${typeData.percentage.toFixed(1)}% of ${category.toLowerCase()})<br/>
                    Regional contribution: ${((typeData.percentage / 100) * categoryPercentage).toFixed(1)}%<br/>
                    <hr style="margin: 5px 0; border: 1px solid #ccc;">
                `;

                // Add war details (limit to first 3)
                const displayWars = typeData.wars.slice(0, 3);
                displayWars.forEach(war => {
                    tooltipContent += `<strong>${war.warName}</strong><br/>`;
                });

                if (typeData.wars.length > 3) {
                    tooltipContent += `<small>... and ${typeData.wars.length - 3} more wars</small>`;
                }

                this.tooltip.transition()
                    .duration(200)
                    .style('opacity', .95);
                
                this.tooltip.html(tooltipContent)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            }

            hideTooltip() {
                this.tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            }

            hideLoading() {
                document.getElementById('inter-intra-loading').style.display = 'none';
                document.getElementById('inter-intra-chart').style.display = 'block';
            }
        }

        // Ethnic vs Nationalist Wars Visualization
        class EthnicNationalistChart {
            constructor() {
                this.data = [];
                this.processedData = [];
                this.svg = null;
                this.tooltip = null;
                this.colorScale = null;
                
                // Chart dimensions - responsive
                this.setDimensions();
            }
            
            setDimensions() {
                // Responsive dimensions based on screen size
                const containerWidth = Math.min(window.innerWidth - 100, 1000);
                const isMobile = window.innerWidth < 768;
                
                this.margin = isMobile 
                    ? { top: 40, right: 20, bottom: 120, left: 80 }
                    : { top: 60, right: 200, bottom: 80, left: 100 };
                    
                this.width = containerWidth - this.margin.left - this.margin.right;
                this.height = isMobile ? 500 : 600;
                this.height = this.height - this.margin.top - this.margin.bottom;
                
                this.init();
            }

            async init() {
                try {
                    console.log('Starting EthnicNationalistChart initialization...');
                    await this.loadData();
                    console.log('Data loaded successfully, processing...');
                    this.processData();
                    console.log('Data processed successfully, creating visualization...');
                    this.createVisualization();
                    console.log('Visualization created successfully');
                    this.hideLoading();
                } catch (error) {
                    console.error('Error initializing ethnic vs nationalist chart:', error);
                    console.error('Error stack:', error.stack);
                    document.getElementById('ethnic-nationalist-loading').innerHTML = 'Error loading data. Please try again.';
                }
            }

            async loadData() {
                // Load war data only
                this.data = await d3.csv('WarList.csv');
                console.log('Loaded ethnic/nationalist data:', this.data.length, 'wars');
            }

            processData() {
                // Filter for ethnic (Type 6) and nationalist (Type 4) wars across full timeframe
                const relevantWars = this.data
                    .filter(d => d['Main type'] === 'INTRA' && 
                               (d['Type Number'] === '4' || d['Type Number'] === '6') &&
                               d['War Name'] && d['Time Span'] && d['Locations'])
                    .map(d => this.cleanWarData(d))
                    .filter(d => d.startYear >= 1816); // Start from first year in dataset

                console.log('Relevant wars (full timeframe):', relevantWars.length);

                // Group wars by region and type
                const regionWarCounts = {};
                
                relevantWars.forEach(war => {
                    war.regions.forEach(region => {
                        if (!regionWarCounts[region]) {
                            regionWarCounts[region] = {
                                ethnic: [],
                                nationalist: []
                            };
                        }
                        
                        if (war.type === '6') {
                            regionWarCounts[region].ethnic.push(war);
                        } else if (war.type === '4') {
                            regionWarCounts[region].nationalist.push(war);
                        }
                    });
                });

                // Convert to array format for visualization
                this.processedData = Object.entries(regionWarCounts)
                    .map(([region, wars]) => {
                        const ethnicCount = wars.ethnic.length;
                        const nationalistCount = wars.nationalist.length;
                        const total = ethnicCount + nationalistCount;
                        
                        return {
                            region: region,
                            ethnicCount: ethnicCount,
                            nationalistCount: nationalistCount,
                            ethnicPercentage: total > 0 ? (ethnicCount / total) * 100 : 0,
                            nationalistPercentage: total > 0 ? (nationalistCount / total) * 100 : 0,
                            totalWars: total,
                            ethnicWars: wars.ethnic,
                            nationalistWars: wars.nationalist
                        };
                    })
                    .filter(d => d.totalWars > 0)
                    .sort((a, b) => b.totalWars - a.totalWars);

                // Create color scale
                this.colorScale = d3.scaleOrdinal()
                    .domain(['ethnic', 'nationalist'])
                    .range(['#AD1332', '#002D40']); // Red for ethnic, blue for nationalist

                console.log('Processed regional data:', this.processedData);
            }

            cleanWarData(war) {
                const timeSpan = war['Time Span'];
                const startYear = parseInt(timeSpan.split('-')[0]);
                
                // Parse locations and map to regions
                const locations = war['Locations']
                    .split(',')
                    .map(loc => loc.trim())
                    .map(loc => loc.replace(/\s*\([^)]*\)/g, ''))
                    .filter(loc => loc.length > 0);

                // Map locations to regions using the existing getRegionFromCountry function
                const regions = [...new Set(locations.map(loc => 
                    this.getRegionFromCountry(loc)
                ))].filter(region => region !== 'Other');

                return {
                    warName: war['War Name'],
                    startYear: startYear,
                    type: war['Type Number'],
                    locations: locations,
                    regions: regions.length > 0 ? regions : ['Other'],
                    timeSpan: timeSpan
                };
            }

            getRegionFromCountry(country) {
                // Map countries to broader regions based on the comprehensive mapping
                const regionMap = {
                    // Europe
                    'Albania': 'Europe',
                    'Austria': 'Europe',
                    'Austria-Hungary': 'Europe',
                    'Baden': 'Europe',
                    'Bavaria': 'Europe',
                    'Belgium': 'Europe',
                    'Bosnia and Herzegovina': 'Europe',
                    'Bosnia': 'Europe',
                    'Bulgaria': 'Europe',
                    'Croatia': 'Europe',
                    'Cyprus': 'Europe',
                    'Czech Rep': 'Europe',
                    'Czech Republic': 'Europe',
                    'Czechoslovakia': 'Europe',
                    'Denmark': 'Europe',
                    'Estonia': 'Europe',
                    'Finland': 'Europe',
                    'France': 'Europe',
                    'Germany': 'Europe',
                    'Great Britain': 'Europe',
                    'Britain': 'Europe',
                    'Greece': 'Europe',
                    'Hanover': 'Europe',
                    'Hesse Electoral': 'Europe',
                    'Hesse Grand Ducal': 'Europe',
                    'Hungary': 'Europe',
                    'Iceland': 'Europe',
                    'Italy': 'Europe',
                    'Latvia': 'Europe',
                    'Lithuania': 'Europe',
                    'Luxembourg': 'Europe',
                    'Macedonia': 'Europe',
                    'Mecklenburg Schwerin': 'Europe',
                    'Modena': 'Europe',
                    'Netherlands': 'Europe',
                    'Norway': 'Europe',
                    'Papal States': 'Europe',
                    'Poland': 'Europe',
                    'Portugal': 'Europe',
                    'Romania': 'Europe',
                    'Russia': 'Europe',
                    'Russia/USSR': 'Europe',
                    'Saxony': 'Europe',
                    'Slovakia': 'Europe',
                    'Spain': 'Europe',
                    'Sweden': 'Europe',
                    'Tuscany': 'Europe',
                    'Two Sicilies': 'Europe',
                    'Ukraine': 'Europe',
                    'United Kingdom': 'Europe',
                    'Wuerttemburg': 'Europe',
                    'Yugoslavia': 'Europe',

                    // Asia
                    'Aceh Sultanate': 'Asia',
                    'Armenia': 'Asia',
                    'Azerbaijan': 'Asia',
                    'Balinese Kingdom of Lombok': 'Asia',
                    'Bangladesh': 'Asia',
                    'Bhutan': 'Asia',
                    'Cambodia': 'Asia',
                    'China': 'Asia',
                    'Georgia': 'Asia',
                    'India': 'Asia',
                    'Indonesia': 'Asia',
                    'Japan': 'Asia',
                    'Kazakhstan': 'Asia',
                    'Khanate of Kiva': 'Asia',
                    'Khanates of Kokand and Bokhara': 'Asia',
                    'Kingdom of Bharatpur': 'Asia',
                    'Kingdom of Lahore': 'Asia',
                    'Kingdom of Sindh': 'Asia',
                    'Korea': 'Asia',
                    'North Korea': 'Asia',
                    'South Korea': 'Asia',
                    'Kyrgystan': 'Asia',
                    'Laos': 'Asia',
                    'Malaysia': 'Asia',
                    'Maratha Empire': 'Asia',
                    'Mongolia': 'Asia',
                    'Myanmar': 'Asia',
                    'Nepal': 'Asia',
                    'Pakistan': 'Asia',
                    'Philippines': 'Asia',
                    'Principality of Jammu': 'Asia',
                    'Republic of Vietnam': 'Asia',
                    'Sri Lanka': 'Asia',
                    'Taiwan': 'Asia',
                    'Tajikistan': 'Asia',
                    'Thailand': 'Asia',
                    'Tibet': 'Asia',
                    'Turkmenistan': 'Asia',
                    'Uzbekistan': 'Asia',
                    'Vietnam': 'Asia',

                    // Middle East
                    'Afghanistan': 'Middle East',
                    'Egypt': 'Middle East',
                    'Iran': 'Middle East',
                    'Iraq': 'Middle East',
                    'Israel': 'Middle East',
                    'Jordan': 'Middle East',
                    'Kuwait': 'Middle East',
                    'Lebanon': 'Middle East',
                    'Oman': 'Middle East',
                    'Qatar': 'Middle East',
                    'Saudi Arabia': 'Middle East',
                    'Syria': 'Middle East',
                    'Turkey': 'Middle East',
                    'United Arab Emirates': 'Middle East',
                    'Yemen': 'Middle East',
                    'Yemen Arab Republic': 'Middle East',
                    'Yemen People\'s Republic': 'Middle East',

                    // Africa
                    'Algeria': 'Africa',
                    'Angola': 'Africa',
                    'Ashanti Kingdom': 'Africa',
                    'Bambara Empire': 'Africa',
                    'Benin': 'Africa',
                    'Benin Empire': 'Africa',
                    'Boer state': 'Africa',
                    'Bornu': 'Africa',
                    'Buganda': 'Africa',
                    'Burundi': 'Africa',
                    'Cameroon': 'Africa',
                    'Chad': 'Africa',
                    'Congo': 'Africa',
                    'Dem. Rep.': 'Africa',
                    'Democratic Republic of the Congo': 'Africa',
                    'Emirates of Kano': 'Africa',
                    'Eritrea': 'Africa',
                    'Ethiopia': 'Africa',
                    'Ghana': 'Africa',
                    'Guinea': 'Africa',
                    'Guinea-Bissau': 'Africa',
                    'Kenya': 'Africa',
                    'Kingdom of Waalo': 'Africa',
                    'Lesotho': 'Africa',
                    'Liberia': 'Africa',
                    'Libya': 'Africa',
                    'Madagascar': 'Africa',
                    'Mali': 'Africa',
                    'Mandingo Empire': 'Africa',
                    'Mauritania': 'Africa',
                    'Morocco': 'Africa',
                    'Mozambique': 'Africa',
                    'Namibia': 'Africa',
                    'Ndebele Kingdom': 'Africa',
                    'Nigeria': 'Africa',
                    'Orange Free State': 'Africa',
                    'Oyo': 'Africa',
                    'Rwanda': 'Africa',
                    'Sanusi Empire': 'Africa',
                    'Senegal': 'Africa',
                    'Sierra Leone': 'Africa',
                    'Sokoto': 'Africa',
                    'Somalia': 'Africa',
                    'South Africa': 'Africa',
                    'South African Republic': 'Africa',
                    'Sudan': 'Africa',
                    'Tanzania': 'Africa',
                    'Transvaal': 'Africa',
                    'Tukolor Empire': 'Africa',
                    'Tunisia': 'Africa',
                    'Uganda': 'Africa',
                    'Xhosa': 'Africa',
                    'Zimbabwe': 'Africa',
                    'Zulu': 'Africa',
                    'Zulu Kingdom': 'Africa',

                    // North America
                    'Canada': 'North America',
                    'Cuba': 'North America',
                    'Dominican Republic': 'North America',
                    'Haiti': 'North America',
                    'Mexico': 'North America',
                    'United States': 'North America',
                    'United States of America': 'North America',

                    // Central America
                    'Costa Rica': 'Central America',
                    'El Salvador': 'Central America',
                    'Guatemala': 'Central America',
                    'Honduras': 'Central America',
                    'Nicaragua': 'Central America',

                    // South America
                    'Argentina': 'South America',
                    'Bolivia': 'South America',
                    'Brazil': 'South America',
                    'Chile': 'South America',
                    'Colombia': 'South America',
                    'Ecuador': 'South America',
                    'Paraguay': 'South America',
                    'Peru': 'South America',
                    'Peru-Bolivia': 'South America',
                    'Uruguay': 'South America',
                    'Venezuela': 'South America',

                    // Oceania
                    'Australia': 'Oceania',
                    'New Zealand': 'Oceania'
                };

                return regionMap[country] || 'Other';
            }

            createVisualization() {
                const container = d3.select('#ethnic-nationalist-chart');
                
                // Create SVG
                const totalHeight = this.height + this.margin.top + this.margin.bottom;
                
                this.svg = container
                    .append('svg')
                    .attr('width', this.width + this.margin.left + this.margin.right)
                    .attr('height', totalHeight)
                    .attr('viewBox', `0 0 ${this.width + this.margin.left + this.margin.right} ${totalHeight}`)
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                const g = this.svg.append('g')
                    .attr('transform', `translate(${this.margin.left},${this.margin.top})`);

                // Create tooltip
                this.tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('z-index', '1001');

                // Create scales
                const xScale = d3.scaleBand()
                    .domain(this.processedData.map(d => d.region))
                    .range([0, this.width])
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, 100]) // Percentage scale
                    .range([this.height, 0]);

                // Create stacked bars
                this.drawStackedBars(g, xScale, yScale);
                
                // Create axes
                this.drawAxes(g, xScale, yScale);
                
                // Create legend
                this.drawLegend(g);
                
                // Add title
                this.addTitle(g);
            }

            drawStackedBars(g, xScale, yScale) {
                const barGroups = g.selectAll('.ethnic-nationalist-bar-group')
                    .data(this.processedData)
                    .enter()
                    .append('g')
                    .attr('class', 'ethnic-nationalist-bar-group')
                    .attr('transform', d => `translate(${xScale(d.region)}, 0)`);

                // Draw stacked bars
                barGroups.each((d, i, nodes) => {
                    const group = d3.select(nodes[i]);
                    
                    // Nationalist wars bar (bottom)
                    if (d.nationalistPercentage > 0) {
                        group.append('rect')
                            .attr('class', 'bar-segment nationalist')
                            .attr('x', 0)
                            .attr('y', yScale(d.nationalistPercentage))
                            .attr('width', xScale.bandwidth())
                            .attr('height', yScale(0) - yScale(d.nationalistPercentage))
                            .attr('fill', this.colorScale('nationalist'))
                            .style('cursor', 'pointer')
                            .on('mouseover', (event) => {
                                this.showTooltip(event, d, 'nationalist');
                            })
                            .on('mouseout', () => {
                                this.hideTooltip();
                            });
                    }
                    
                    // Ethnic wars bar (top)
                    if (d.ethnicPercentage > 0) {
                        group.append('rect')
                            .attr('class', 'bar-segment ethnic')
                            .attr('x', 0)
                            .attr('y', yScale(100))
                            .attr('width', xScale.bandwidth())
                            .attr('height', yScale(100 - d.ethnicPercentage) - yScale(100))
                            .attr('fill', this.colorScale('ethnic'))
                            .style('cursor', 'pointer')
                            .on('mouseover', (event) => {
                                this.showTooltip(event, d, 'ethnic');
                            })
                            .on('mouseout', () => {
                                this.hideTooltip();
                            });
                    }
                });
            }

            drawAxes(g, xScale, yScale) {
                // X-axis
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0, ${this.height})`)
                    .call(d3.axisBottom(xScale))
                    .selectAll('text')
                    .style('text-anchor', 'end')
                    .attr('dx', '-.8em')
                    .attr('dy', '.15em')
                    .attr('transform', 'rotate(-45)')
                    .style('font-size', '11px');

                // Y-axis
                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(yScale).tickFormat(d => d + '%'));

                // Axis labels
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('x', this.width / 2)
                    .attr('y', this.height + 70)
                    .style('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .text('Region');

                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', 'rotate(-90)')
                    .attr('x', -this.height / 2)
                    .attr('y', -60)
                    .style('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .text('Percentage of Wars by Type');
            }

            drawLegend(g) {
                const isMobile = window.innerWidth < 768;
                
                const legend = g.append('g')
                    .attr('class', 'legend')
                    .attr('transform', isMobile ? 
                        `translate(20, ${this.height + 90})` : 
                        `translate(${this.width + 20}, 20)`);

                const legendData = [
                    { type: 'ethnic', label: 'Ethnic Wars (Type 6)', color: this.colorScale('ethnic') },
                    { type: 'nationalist', label: 'Nationalist Wars (Type 4)', color: this.colorScale('nationalist') }
                ];

                const legendItems = legend.selectAll('.legend-item')
                    .data(legendData)
                    .enter()
                    .append('g')
                    .attr('class', 'legend-item')
                    .attr('transform', (d, i) => isMobile ? 
                        `translate(${i * 200}, 0)` : 
                        `translate(0, ${i * 25})`);

                legendItems.append('rect')
                    .attr('width', 15)
                    .attr('height', 15)
                    .attr('fill', d => d.color)
                    .attr('stroke', '#333')
                    .attr('stroke-width', 1);

                legendItems.append('text')
                    .attr('x', 20)
                    .attr('y', 12)
                    .text(d => d.label)
                    .style('font-size', '12px')
                    .style('fill', '#333');
            }

            addTitle(g) {
                g.append('text')
                    .attr('class', 'chart-title')
                    .attr('x', this.width / 2)
                    .attr('y', -30)
                    .style('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .style('font-weight', 'bold')
                    .style('fill', '#2c3e50')
                    .text('Ethnic vs Nationalist Wars by Region (1816-Present)');
            }

            showTooltip(event, regionData, warType) {
                const wars = warType === 'ethnic' ? regionData.ethnicWars : regionData.nationalistWars;
                const count = warType === 'ethnic' ? regionData.ethnicCount : regionData.nationalistCount;
                const percentage = warType === 'ethnic' ? regionData.ethnicPercentage : regionData.nationalistPercentage;
                
                let tooltipContent = `
                    <strong>${regionData.region}</strong><br/>
                    <strong>${warType === 'ethnic' ? 'Ethnic' : 'Nationalist'} Wars:</strong> ${count} (${percentage.toFixed(1)}%)<br/>
                    <strong>Total Wars:</strong> ${regionData.totalWars}<br/>
                    <hr style="margin: 5px 0; border: 1px solid #ccc;">
                `;

                // Add war details (limit to first 5 wars)
                const displayWars = wars.slice(0, 5);
                displayWars.forEach(war => {
                    tooltipContent += `
                        <strong>${war.warName}</strong><br/>
                        <em>${war.timeSpan}</em><br/>
                        <small>Locations: ${war.locations.join(', ')}</small><br/><br/>
                    `;
                });

                if (wars.length > 5) {
                    tooltipContent += `<small>... and ${wars.length - 5} more wars</small>`;
                }

                this.tooltip.transition()
                    .duration(200)
                    .style('opacity', .95);
                
                this.tooltip.html(tooltipContent)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            }

            hideTooltip() {
                this.tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            }

            hideLoading() {
                document.getElementById('ethnic-nationalist-loading').style.display = 'none';
                document.getElementById('ethnic-nationalist-chart').style.display = 'block';
            }
        }

        // War Duration Heatmap Visualization
        class WarDurationHeatmap {
            constructor() {
                this.data = [];
                this.processedData = [];
                this.svg = null;
                this.tooltip = null;
                this.colorScale = null;
                this.regions = [];
                this.decades = [];
                this.regionsMap = {};
                
                // Chart dimensions - responsive
                this.setDimensions();
            }
            
            setDimensions() {
                // Fixed dimensions for 1000x600 total size with vertical legend
                const totalWidth = 1000;
                const totalHeight = 600;
                const legendWidth = 100;
                
                this.margin = { top: 60, right: 20, bottom: 80, left: 120 };
                
                // Reserve space for vertical legend on the right
                this.width = totalWidth - this.margin.left - this.margin.right - legendWidth - 20;
                this.height = totalHeight - this.margin.top - this.margin.bottom;
                this.legendWidth = legendWidth;
                this.totalWidth = totalWidth;
                this.totalHeight = totalHeight;
                
                this.init();
            }

            async init() {
                try {
                    console.log('Starting WarDurationHeatmap initialization...');
                    this.createRegionsMap();
                    await this.loadData();
                    console.log('Data loaded successfully, processing...');
                    this.processData();
                    console.log('Data processed successfully, creating visualization...');
                    this.createVisualization();
                    console.log('Heatmap visualization created successfully');
                    this.hideLoading();
                } catch (error) {
                    console.error('Error initializing heatmap:', error);
                    document.getElementById('region-start-duration-heatmap-loading').innerHTML = 'Error loading data. Please try again.';
                }
            }

            createRegionsMap() {
                // Create inline regions mapping based on the existing region mapping function
                this.regionsMap = {
                    // Europe
                    'Albania': 'Europe', 'Austria': 'Europe', 'Austria-Hungary': 'Europe', 'Baden': 'Europe', 'Bavaria': 'Europe',
                    'Belgium': 'Europe', 'Bosnia and Herzegovina': 'Europe', 'Bosnia': 'Europe', 'Bulgaria': 'Europe', 'Croatia': 'Europe',
                    'Cyprus': 'Europe', 'Czech Rep': 'Europe', 'Czech Republic': 'Europe', 'Czechoslovakia': 'Europe', 'Denmark': 'Europe',
                    'Estonia': 'Europe', 'Finland': 'Europe', 'France': 'Europe', 'Germany': 'Europe', 'Great Britain': 'Europe',
                    'Britain': 'Europe', 'Greece': 'Europe', 'Hanover': 'Europe', 'Hesse Electoral': 'Europe', 'Hesse Grand Ducal': 'Europe',
                    'Hungary': 'Europe', 'Iceland': 'Europe', 'Italy': 'Europe', 'Latvia': 'Europe', 'Lithuania': 'Europe',
                    'Luxembourg': 'Europe', 'Macedonia': 'Europe', 'Mecklenburg Schwerin': 'Europe', 'Modena': 'Europe', 'Netherlands': 'Europe',
                    'Norway': 'Europe', 'Papal States': 'Europe', 'Poland': 'Europe', 'Portugal': 'Europe', 'Romania': 'Europe',
                    'Russia': 'Europe', 'Russia/USSR': 'Europe', 'Saxony': 'Europe', 'Slovakia': 'Europe', 'Spain': 'Europe',
                    'Sweden': 'Europe', 'Tuscany': 'Europe', 'Two Sicilies': 'Europe', 'Ukraine': 'Europe', 'United Kingdom': 'Europe',
                    'Wuerttemburg': 'Europe', 'Yugoslavia': 'Europe',

                    // Asia
                    'Aceh Sultanate': 'Asia', 'Armenia': 'Asia', 'Azerbaijan': 'Asia', 'Balinese Kingdom of Lombok': 'Asia',
                    'Bangladesh': 'Asia', 'Bhutan': 'Asia', 'Cambodia': 'Asia', 'China': 'Asia', 'Georgia': 'Asia', 'India': 'Asia',
                    'Indonesia': 'Asia', 'Japan': 'Asia', 'Kazakhstan': 'Asia', 'Khanate of Kiva': 'Asia', 'Khanates of Kokand and Bokhara': 'Asia',
                    'Kingdom of Bharatpur': 'Asia', 'Kingdom of Lahore': 'Asia', 'Kingdom of Sindh': 'Asia', 'Korea': 'Asia',
                    'North Korea': 'Asia', 'South Korea': 'Asia', 'Kyrgystan': 'Asia', 'Laos': 'Asia', 'Malaysia': 'Asia',
                    'Maratha Empire': 'Asia', 'Mongolia': 'Asia', 'Myanmar': 'Asia', 'Nepal': 'Asia', 'Pakistan': 'Asia',
                    'Philippines': 'Asia', 'Principality of Jammu': 'Asia', 'Republic of Vietnam': 'Asia', 'Sri Lanka': 'Asia',
                    'Taiwan': 'Asia', 'Tajikistan': 'Asia', 'Thailand': 'Asia', 'Tibet': 'Asia', 'Turkmenistan': 'Asia',
                    'Uzbekistan': 'Asia', 'Vietnam': 'Asia',

                    // Middle East
                    'Afghanistan': 'Middle East', 'Egypt': 'Middle East', 'Iran': 'Middle East', 'Iraq': 'Middle East',
                    'Israel': 'Middle East', 'Jordan': 'Middle East', 'Kuwait': 'Middle East', 'Lebanon': 'Middle East',
                    'Oman': 'Middle East', 'Qatar': 'Middle East', 'Saudi Arabia': 'Middle East', 'Syria': 'Middle East',
                    'Turkey': 'Middle East', 'United Arab Emirates': 'Middle East', 'Yemen': 'Middle East',
                    'Yemen Arab Republic': 'Middle East', 'Yemen People\'s Republic': 'Middle East',

                    // Africa
                    'Algeria': 'Africa', 'Angola': 'Africa', 'Ashanti Kingdom': 'Africa', 'Bambara Empire': 'Africa',
                    'Benin': 'Africa', 'Benin Empire': 'Africa', 'Boer state': 'Africa', 'Bornu': 'Africa', 'Buganda': 'Africa',
                    'Burundi': 'Africa', 'Cameroon': 'Africa', 'Chad': 'Africa', 'Congo': 'Africa', 'Dem. Rep.': 'Africa',
                    'Democratic Republic of the Congo': 'Africa', 'Emirates of Kano': 'Africa', 'Eritrea': 'Africa', 'Ethiopia': 'Africa',
                    'Ghana': 'Africa', 'Guinea': 'Africa', 'Guinea-Bissau': 'Africa', 'Kenya': 'Africa', 'Kingdom of Waalo': 'Africa',
                    'Lesotho': 'Africa', 'Liberia': 'Africa', 'Libya': 'Africa', 'Madagascar': 'Africa', 'Mali': 'Africa',
                    'Mandingo Empire': 'Africa', 'Mauritania': 'Africa', 'Morocco': 'Africa', 'Mozambique': 'Africa', 'Namibia': 'Africa',
                    'Ndebele Kingdom': 'Africa', 'Nigeria': 'Africa', 'Orange Free State': 'Africa', 'Oyo': 'Africa', 'Rwanda': 'Africa',
                    'Sanusi Empire': 'Africa', 'Senegal': 'Africa', 'Sierra Leone': 'Africa', 'Sokoto': 'Africa', 'Somalia': 'Africa',
                    'South Africa': 'Africa', 'South African Republic': 'Africa', 'Sudan': 'Africa', 'Tanzania': 'Africa',
                    'Transvaal': 'Africa', 'Tukolor Empire': 'Africa', 'Tunisia': 'Africa', 'Uganda': 'Africa', 'Xhosa': 'Africa',
                    'Zimbabwe': 'Africa', 'Zulu': 'Africa', 'Zulu Kingdom': 'Africa',

                    // North America
                    'Canada': 'North America', 'Cuba': 'North America', 'Dominican Republic': 'North America',
                    'Haiti': 'North America', 'Mexico': 'North America', 'United States': 'North America',
                    'United States of America': 'North America',

                    // Central America
                    'Costa Rica': 'Central America', 'El Salvador': 'Central America', 'Guatemala': 'Central America',
                    'Honduras': 'Central America', 'Nicaragua': 'Central America',

                    // South America
                    'Argentina': 'South America', 'Bolivia': 'South America', 'Brazil': 'South America',
                    'Chile': 'South America', 'Colombia': 'South America', 'Ecuador': 'South America',
                    'Paraguay': 'South America', 'Peru': 'South America', 'Peru-Bolivia': 'South America',
                    'Uruguay': 'South America', 'Venezuela': 'South America',

                    // Oceania
                    'Australia': 'Oceania', 'New Zealand': 'Oceania'
                };
            }

            async loadData() {
                this.data = await d3.csv('WarList.csv');
                console.log('Loaded heatmap data:', this.data.length, 'wars');
            }

            processData() {
                // Clean and process the data according to specification
                const cleanWars = this.data
                    .filter(d => d['War Name'] && d['Time Span'] && d['Locations'])
                    .map(d => this.cleanWarData(d))
                    .filter(d => d !== null); // Remove unparsable wars

                console.log('Clean wars for heatmap:', cleanWars.length);

                // Aggregate by region and decade
                const aggregation = {};
                const warDetails = {}; // Store war details for tooltips

                cleanWars.forEach(war => {
                    const startBin = (Math.floor(war.startYear / 10) * 10).toString();
                    
                    war.allocatedLocations.forEach(({location, allocation}) => {
                        const region = this.regionsMap[location] || 'Other';
                        
                        const key = `${region}-${startBin}`;
                        if (!aggregation[key]) {
                            aggregation[key] = 0;
                            warDetails[key] = [];
                        }
                        
                        aggregation[key] += allocation;
                        warDetails[key].push({
                            warName: war.warName,
                            warNumber: war.warNumber,
                            timeSpan: war.timeSpan,
                            allLocations: war.originalLocations,
                            stateParticipants: war.stateParticipants,
                            allocation: allocation,
                            region: region
                        });
                    });
                });

                // Convert to array format for heatmap
                this.processedData = [];
                const regionTotals = {};

                // Get all unique regions and decades
                // Keep regions in original order (unsorted) as specified in requirements
                const regionOrder = {};
                let orderIndex = 0;
                
                Object.keys(aggregation).forEach(key => {
                    const region = key.split('-')[0];
                    if (!(region in regionOrder)) {
                        regionOrder[region] = orderIndex++;
                    }
                });
                
                this.regions = Object.keys(regionOrder).sort((a, b) => regionOrder[a] - regionOrder[b]);
                this.decades = [...new Set(Object.keys(aggregation).map(key => key.split('-')[1]))].sort();

                // Create data structure with region objects
                this.regions.forEach(region => {
                    const regionData = {
                        region: region,
                        bins: {},
                        TOTAL_DURATION: 0
                    };

                    this.decades.forEach(decade => {
                        const key = `${region}-${decade}`;
                        const value = aggregation[key] || 0;
                        regionData.bins[decade] = value;
                        regionData.TOTAL_DURATION += value;
                    });

                    // Add war details for tooltips
                    regionData.warDetails = {};
                    this.decades.forEach(decade => {
                        const key = `${region}-${decade}`;
                        regionData.warDetails[decade] = warDetails[key] || [];
                    });

                    this.processedData.push(regionData);
                });

                // Create color scale - using consistent colors with other charts
                const maxValue = d3.max(this.processedData, d => d3.max(Object.values(d.bins)));
                this.colorScale = d3.scaleSequential()
                    .domain([0, maxValue])
                    .interpolator(d3.interpolateOrRd); // Using OrRd for consistency with website theme

                console.log('Processed heatmap data:', this.processedData);
                console.log('Decades:', this.decades);
                console.log('Max value:', maxValue);
            }

            cleanWarData(war) {
                try {
                    // Normalize headers - remove newlines
                    const timeSpan = war['Time Span'];
                    const warName = war['War Name'];
                    const locations = war['Locations'];
                    const stateParticipants = war['State Participants'] || '';
                    const warNumber = war['War\nNumber'] || war['War Number'] || war['"War\nNumber"'] || '';

                    // Parse start and end year
                    let startYear, endYear;
                    
                    if (timeSpan.includes('-')) {
                        const years = timeSpan.split('-');
                        startYear = parseInt(years[0]);
                        endYear = parseInt(years[1]);
                    } else {
                        // Single year
                        startYear = endYear = parseInt(timeSpan);
                    }

                    if (isNaN(startYear) || isNaN(endYear)) {
                        console.warn(`Unparsable time span: ${timeSpan} for war: ${warName}`);
                        return null;
                    }

                    // Calculate duration
                    const duration = endYear - startYear + 1;

                    // Parse and clean locations
                    const parsedLocations = locations
                        .split(',')
                        .map(loc => loc.trim())
                        .map(loc => loc.replace(/^["']|["']$/g, '')) // Remove surrounding quotes
                        .map(loc => loc.replace(/\s*\([^)]*\)/g, '')) // Remove parenthetical content
                        .filter(loc => loc.length > 0);

                    // Deduplicate locations
                    const uniqueLocations = [...new Set(parsedLocations)];
                    
                    // Split duration equally among locations
                    const allocationPerLocation = duration / uniqueLocations.length;
                    
                    const allocatedLocations = uniqueLocations.map(location => ({
                        location: location,
                        allocation: allocationPerLocation
                    }));

                    return {
                        warName: warName,
                        warNumber: warNumber,
                        timeSpan: timeSpan,
                        startYear: startYear,
                        endYear: endYear,
                        duration: duration,
                        originalLocations: parsedLocations,
                        allocatedLocations: allocatedLocations,
                        stateParticipants: stateParticipants
                    };
                } catch (error) {
                    console.warn(`Error processing war data for ${war['War Name']}:`, error);
                    return null;
                }
            }

            createVisualization() {
                const container = d3.select('#region-start-duration-heatmap');
                
                // Clear any existing content
                container.selectAll('*').remove();
                
                // Create SVG with fixed 1000x600 size
                this.svg = container
                    .append('svg')
                    .attr('width', this.totalWidth)
                    .attr('height', this.totalHeight)
                    .attr('viewBox', `0 0 ${this.totalWidth} ${this.totalHeight}`)
                    .attr('preserveAspectRatio', 'xMidYMid meet');

                const g = this.svg.append('g')
                    .attr('transform', `translate(${this.margin.left},${this.margin.top})`);

                // Create tooltip
                this.tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('z-index', '1001');

                // Create scales
                const xScale = d3.scaleBand()
                    .domain(this.decades)
                    .range([0, this.width])
                    .padding(0.05);

                const yScale = d3.scaleBand()
                    .domain(this.regions)
                    .range([0, this.height])
                    .padding(0.05);

                // Draw heatmap cells
                this.drawHeatmapCells(g, xScale, yScale);
                
                // Create axes
                this.drawAxes(g, xScale, yScale);
                
                // Add color legend
                this.drawColorLegend(g);
                
                // Add title
                this.addTitle(g);
            }

            drawHeatmapCells(g, xScale, yScale) {
                // Create heatmap data for D3
                const heatmapData = [];
                this.processedData.forEach(regionData => {
                    this.decades.forEach(decade => {
                        heatmapData.push({
                            region: regionData.region,
                            decade: decade,
                            value: regionData.bins[decade],
                            warDetails: regionData.warDetails[decade]
                        });
                    });
                });

                const cells = g.selectAll('.heatmap-cell')
                    .data(heatmapData)
                    .enter()
                    .append('rect')
                    .attr('class', 'heatmap-cell')
                    .attr('x', d => xScale(d.decade))
                    .attr('y', d => yScale(d.region))
                    .attr('width', xScale.bandwidth())
                    .attr('height', yScale.bandwidth())
                    .attr('fill', d => d.value > 0 ? this.colorScale(d.value) : '#f0f0f0')
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 1)
                    .style('cursor', 'pointer')
                    .on('mouseover', (event, d) => {
                        this.showTooltip(event, d);
                    })
                    .on('mouseout', () => {
                        this.hideTooltip();
                    });

                // Add text labels for non-zero values
                g.selectAll('.cell-text')
                    .data(heatmapData.filter(d => d.value > 0))
                    .enter()
                    .append('text')
                    .attr('class', 'cell-text')
                    .attr('x', d => xScale(d.decade) + xScale.bandwidth() / 2)
                    .attr('y', d => yScale(d.region) + yScale.bandwidth() / 2)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .style('font-size', '9px')
                    .style('font-weight', 'bold')
                    .style('fill', d => d.value > this.colorScale.domain()[1] * 0.5 ? 'white' : 'black')
                    .text(d => d.value >= 10 ? d.value.toFixed(0) : d.value.toFixed(1))
                    .style('pointer-events', 'none');
            }

            drawAxes(g, xScale, yScale) {
                // X-axis (decades)
                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0, ${this.height})`)
                    .call(d3.axisBottom(xScale))
                    .selectAll('text')
                    .style('font-size', '11px')
                    .style('text-anchor', 'middle');

                // Y-axis (regions)
                g.append('g')
                    .attr('class', 'axis')
                    .call(d3.axisLeft(yScale))
                    .selectAll('text')
                    .style('font-size', '11px');

                // Axis labels
                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('x', this.width / 2)
                    .attr('y', this.height + 50)
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('font-weight', 'bold')
                    .text('Decade (Start Year)');

                g.append('text')
                    .attr('class', 'axis-label')
                    .attr('transform', 'rotate(-90)')
                    .attr('x', -this.height / 2)
                    .attr('y', -80)
                    .style('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .style('font-weight', 'bold')
                    .text('Region');
            }

            drawColorLegend(g) {
                const legendHeight = this.height - 80; // Leave some margin at top and bottom
                const legendBarWidth = 20;
                
                const legendData = d3.range(0, 1.01, 0.01);
                const legendScale = d3.scaleLinear()
                    .domain([0, 1])
                    .range([legendHeight, 0]); // Inverted for vertical legend

                const legend = g.append('g')
                    .attr('class', 'color-legend')
                    .attr('transform', `translate(${this.width + 30}, 40)`);

                // Draw vertical color gradient
                legend.selectAll('.legend-rect')
                    .data(legendData)
                    .enter()
                    .append('rect')
                    .attr('class', 'legend-rect')
                    .attr('x', 0)
                    .attr('y', d => legendScale(d))
                    .attr('width', legendBarWidth)
                    .attr('height', legendHeight / legendData.length + 1)
                    .attr('fill', d => this.colorScale(d * this.colorScale.domain()[1]));

                // Add legend scale (vertical)
                const legendAxis = d3.scaleLinear()
                    .domain(this.colorScale.domain())
                    .range([legendHeight, 0]);

                legend.append('g')
                    .attr('transform', `translate(${legendBarWidth}, 0)`)
                    .call(d3.axisRight(legendAxis)
                        .ticks(6)
                        .tickFormat(d3.format('.1f')));

                // Add legend title (vertical)
                legend.append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('x', -legendHeight / 2)
                    .attr('y', -15)
                    .style('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .style('font-weight', 'bold')
                    .text('Total Duration (Years)');
            }

            addTitle(g) {
                g.append('text')
                    .attr('class', 'chart-title')
                    .attr('x', this.width / 2)
                    .attr('y', -50)
                    .style('text-anchor', 'middle')
                    .style('font-size', '18px')
                    .style('font-weight', 'bold')
                    .style('fill', '#2c3e50')
                    .text('War Duration Heatmap by Region and Decade');

                g.append('text')
                    .attr('class', 'chart-subtitle')
                    .attr('x', this.width / 2)
                    .attr('y', -30)
                    .style('text-anchor', 'middle')
                    .style('font-size', '12px')
                    .style('fill', '#666')
                    .text('Sum of war durations allocated to regions based on start decade');
            }

            showTooltip(event, d) {
                let tooltipContent = `
                    <strong>Region:</strong> ${d.region}<br/>
                    <strong>Decade:</strong> ${d.decade}s<br/>
                    <strong>Total Duration:</strong> ${d.value.toFixed(2)} years<br/>
                    <strong>Number of Wars:</strong> ${d.warDetails.length}<br/>
                `;

                if (d.warDetails.length > 0) {
                    tooltipContent += '<hr style="margin: 5px 0; border: 1px solid #ccc;">';
                    tooltipContent += '<strong>Contributing Wars:</strong><br/>';
                    
                    // Show up to 5 wars in detail as per specification
                    const displayWars = d.warDetails.slice(0, 5);
                    displayWars.forEach(war => {
                        tooltipContent += `
                            <strong>War Name:</strong> ${war.warName}<br/>
                            <strong>War Number:</strong> ${war.warNumber}<br/>
                            <strong>State Participants:</strong> ${war.stateParticipants}<br/>
                            <strong>All Locations:</strong> ${war.allLocations.join(', ')}<br/>
                            <strong>Duration Contribution:</strong> ${war.allocation.toFixed(2)} years to ${war.region}<br/>
                            <hr style="margin: 3px 0; border: 0.5px solid #ddd;">
                        `;
                    });

                    if (d.warDetails.length > 5) {
                        tooltipContent += `<em>... and ${d.warDetails.length - 5} more wars</em>`;
                    }
                }

                this.tooltip.transition()
                    .duration(200)
                    .style('opacity', .95);
                
                this.tooltip.html(tooltipContent)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            }

            hideTooltip() {
                this.tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            }

            hideLoading() {
                document.getElementById('region-start-duration-heatmap-loading').style.display = 'none';
                document.getElementById('region-start-duration-heatmap').style.display = 'block';
            }
        }

        // Initialize the visualizations when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            const interIntraChart = new InterIntraChart();
            const chart = new RegionalConflictsChart();
            const ethnicNationalistChart = new EthnicNationalistChart();
            const warDurationHeatmap = new WarDurationHeatmap();
            
            // Handle window resize for responsive design
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    // Recreate charts with new dimensions
                    if (interIntraChart.processedData && interIntraChart.processedData.length > 0) {
                        d3.select('#inter-intra-chart').selectAll('*').remove();
                        interIntraChart.setDimensions();
                        interIntraChart.createVisualization();
                    }
                    
                    if (chart.processedData && chart.processedData.length > 0) {
                        d3.select('#chart-container').selectAll('*').remove();
                        chart.setDimensions();
                        chart.createVisualization();
                    }
                    
                    if (ethnicNationalistChart.processedData && ethnicNationalistChart.processedData.length > 0) {
                        d3.select('#ethnic-nationalist-chart').selectAll('*').remove();
                        ethnicNationalistChart.setDimensions();
                        ethnicNationalistChart.createVisualization();
                    }
                    
                    if (warDurationHeatmap.processedData && warDurationHeatmap.processedData.length > 0) {
                        d3.select('#region-start-duration-heatmap').selectAll('*').remove();
                        warDurationHeatmap.createVisualization(); // Skip setDimensions() since we want fixed size
                    }
                }, 250);
            });
        });
    </script>
</body>
</html>